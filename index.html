<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Digital Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –°–¢–ò–õ–ò (CSS) --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
            margin: 0; padding: 0; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ */
        .page { display: none; padding-bottom: 90px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –®–∞–ø–∫–∞ */
        .header {
            position: sticky; top: 0; z-index: 100;
            background-color: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 15px 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }

        /* –ü–æ–∏—Å–∫ */
        .search-input {
            width: 100%; box-sizing: border-box; padding: 12px 15px;
            border-radius: 12px; border: none; outline: none;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000); font-size: 16px;
            margin-bottom: 10px;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-hint-color, #888); font-size: 14px; font-weight: 600;
            cursor: pointer; transition: 0.2s;
        }
        .tab.active {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }

        /* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        .product-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px;
        }

        .card {
            background: var(--tg-theme-bg-color, #fff);
            border: 1px solid var(--tg-theme-secondary-bg-color, #e0e0e0);
            border-radius: 16px; padding: 12px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            position: relative; overflow: hidden;
        }

        .card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
        .name { font-size: 14px; font-weight: 700; margin-bottom: 4px; line-height: 1.2; }
        .price { font-size: 15px; font-weight: 400; color: var(--tg-theme-hint-color, #888); margin-bottom: 12px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-add {
            width: 100%; padding: 10px 0; border-radius: 10px; border: none;
            background-color: var(--tg-theme-secondary-bg-color, #eef);
            color: var(--tg-theme-button-color, #3390ec);
            font-weight: 700; cursor: pointer;
        }
        
        .counter {
            display: none; width: 100%; justify-content: space-between; align-items: center;
            background-color: var(--tg-theme-button-color, #3390ec);
            border-radius: 10px; color: white; padding: 2px;
        }
        .counter button {
            background: none; border: none; color: white; font-size: 20px; width: 35px; height: 32px; cursor: pointer;
        }
        .counter span { font-weight: 600; font-size: 15px; }

        /* –ö–æ—Ä–∑–∏–Ω–∞ */
        .cart-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        .cart-info div:first-child { font-weight: 600; font-size: 16px; }
        .cart-info div:last-child { color: #888; font-size: 14px; }
        
        .cart-controls {
            display: flex; align-items: center; gap: 10px;
            background: var(--tg-theme-secondary-bg-color, #eee);
            padding: 5px 10px; border-radius: 8px;
        }
        .cart-controls button { border: none; background: none; font-size: 18px; color: var(--tg-theme-text-color); }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .popup-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 200;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .popup-overlay.show { display: flex; }
        .popup-content {
            background: var(--tg-theme-bg-color, #fff); width: 85%; max-width: 320px;
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .popup-img { width: 100px; height: 100px; margin-bottom: 15px; }
        
    </style>
</head>
<body>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ö–ê–¢–ê–õ–û–ì -->
    <div id="catalogPage" class="page active">
        <div class="header">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ Stars, Premium...">
            <div class="tabs">
                <div class="tab active" onclick="filterCategory('all', this)">–í—Å–µ</div>
                <div class="tab" onclick="filterCategory('stars', this)">üåü –ó–≤–µ–∑–¥—ã</div>
                <div class="tab" onclick="filterCategory('premium', this)">üíé Premium</div>
                <div class="tab" onclick="filterCategory('gifts', this)">üéÅ –ü–æ–¥–∞—Ä–∫–∏</div>
            </div>
        </div>
        <div id="grid" class="product-grid"></div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –ö–û–†–ó–ò–ù–ê -->
    <div id="cartPage" class="page">
        <div style="padding: 20px;">
            <h2 style="margin-top: 0;">–í–∞—à –∑–∞–∫–∞–∑ ‚ö°Ô∏è</h2>
            <div id="cartList"></div>
            <div id="emptyCart" style="text-align: center; color: #888; margin-top: 50px; display: none;">
                –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (POPUP) -->
    <div id="popup" class="popup-overlay" onclick="closePopup(event)">
        <div class="popup-content">
            <img id="popupImg" class="popup-img" src="">
            <h3 id="popupTitle"></h3>
            <p id="popupDesc" style="color: #666; font-size: 14px; margin: 10px 0 20px;"></p>
            <div id="popupPrice" style="font-weight: 800; font-size: 20px; margin-bottom: 20px;"></div>
            <button class="btn-add" style="background: var(--tg-theme-button-color); color: #fff;" onclick="closePopupDirect()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation(); // –°–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

        // --- üì¶ –¢–û–í–ê–†–´ (–¶–ò–§–†–û–í–´–ï) ---
        // –ö–∞—Ä—Ç–∏–Ω–∫–∏: –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã. –ó–∞–º–µ–Ω–∏—Ç–µ –∏—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ URL!
        const products = [
            // Stars
            { id: 1, category: "stars", name: "50 Telegram Stars", price: 6.90, img: "https://placehold.co/200/gold/white?text=50+Stars", desc: "–î–ª—è –æ–ø–ª–∞—Ç—ã —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–æ—Ç–∞—Ö." },
            { id: 2, category: "stars", name: "100 Telegram Stars", price: 12.50, img: "https://placehold.co/200/gold/white?text=100+Stars", desc: "–í—ã–≥–æ–¥–Ω—ã–π –ø–∞–∫–µ—Ç –∑–≤–µ–∑–¥." },
            { id: 3, category: "stars", name: "500 Telegram Stars", price: 55.00, img: "https://placehold.co/200/gold/white?text=500+Stars", desc: "–ë–æ–ª—å—à–æ–π –ø–∞–∫–µ—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π." },
            
            // Premium
            { id: 4, category: "premium", name: "Premium 1 –ú–µ—Å—è—Ü", price: 14.00, img: "https://placehold.co/200/9b59b6/white?text=1+Month", desc: "–õ–∏–º–∏—Ç—ã x2, –±–µ–∑ —Ä–µ–∫–ª–∞–º—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã." },
            { id: 5, category: "premium", name: "Premium 12 –ú–µ—Å—è—Ü–µ–≤", price: 110.00, img: "https://placehold.co/200/9b59b6/white?text=1+Year", desc: "–ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å –≤—ã–≥–æ–¥–æ–π 30%." },

            // Gifts
            { id: 6, category: "gifts", name: "–ü–æ–¥–∞—Ä–æ–∫ '–¢–æ—Ä—Ç'", price: 5.00, img: "https://placehold.co/200/e74c3c/white?text=Cake", desc: "–í–∫—É—Å–Ω—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ—Ä—Ç –≤ –ø—Ä–æ—Ñ–∏–ª—å." },
            { id: 7, category: "gifts", name: "–ü–æ–¥–∞—Ä–æ–∫ '–ó–≤–µ–∑–¥–∞'", price: 3.50, img: "https://placehold.co/200/f1c40f/white?text=Star", desc: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –∑–≤–µ–∑–¥–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é." }
        ];

        let cart = {}; 
        let currentCategory = 'all';
        let currentPage = 'catalog';

        const grid = document.getElementById('grid');
        const searchInput = document.getElementById('searchInput');

        // --- üé® –û–¢–†–ò–°–û–í–ö–ê –ö–ê–¢–ê–õ–û–ì–ê ---
        function renderCatalog(items) {
            grid.innerHTML = "";
            if (items.length === 0) {
                grid.innerHTML = "<div style='grid-column: span 2; text-align: center; color: #888; padding: 20px;'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>";
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                // –í–ê–ñ–ù–û: –í –∫–Ω–æ–ø–∫–µ –º–∏–Ω—É—Å–∞ —Å—Ç–æ–∏—Ç -1
                div.innerHTML = `
                    <img src="${item.img}" onclick="openPopup(${item.id})">
                    <div class="name">${item.name}</div>
                    <div class="price">${item.price.toFixed(2)} BYN</div>
                    
                    <button class="btn-add" id="add-${item.id}" onclick="updateCart(${item.id}, 1)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    
                    <div class="counter" id="counter-${item.id}">
                        <button onclick="updateCart(${item.id}, -1)">‚àí</button>
                        <span id="count-${item.id}">0</span>
                        <button onclick="updateCart(${item.id}, 1)">+</button>
                    </div>
                `;
                grid.appendChild(div);
                if (cart[item.id]) showCounter(item.id, cart[item.id]);
            });
        }

        // --- üßÆ –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) ---
        function updateCart(id, change) {
            tg.HapticFeedback.impactOccurred('light');

            // 1. –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ —á–∏—Å–ª–∞ (FIX)
            const productId = Number(id);
            const delta = Number(change);

            // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            if (!cart[productId]) cart[productId] = 0;

            // 3. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
            cart[productId] += delta;

            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            if (cart[productId] <= 0) {
                delete cart[productId];
                hideCounter(productId);
            } else {
                showCounter(productId, cart[productId]);
            }

            // 5. –ï—Å–ª–∏ –º—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
            if (currentPage === 'cart') renderCartPage();

            updateMainButton();
        }

        function showCounter(id, count) {
            const addBtn = document.getElementById(`add-${id}`);
            const counter = document.getElementById(`counter-${id}`);
            const countSpan = document.getElementById(`count-${id}`);
            if(addBtn && counter) {
                addBtn.style.display = 'none';
                counter.style.display = 'flex';
                countSpan.innerText = count;
            }
        }

        function hideCounter(id) {
            const addBtn = document.getElementById(`add-${id}`);
            const counter = document.getElementById(`counter-${id}`);
            if(addBtn && counter) {
                addBtn.style.display = 'block';
                counter.style.display = 'none';
            }
        }

        // --- üõí –°–¢–†–ê–ù–ò–¶–ê –ö–û–†–ó–ò–ù–´ ---
        function renderCartPage() {
            const list = document.getElementById('cartList');
            const emptyMsg = document.getElementById('emptyCart');
            list.innerHTML = "";
            
            const ids = Object.keys(cart);
            if (ids.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            ids.forEach(id => {
                const product = products.find(p => p.id == id);
                if(product) {
                    const el = document.createElement('div');
                    el.className = 'cart-item';
                    el.innerHTML = `
                        <div class="cart-info">
                            <div>${product.name}</div>
                            <div>${product.price.toFixed(2)} BYN</div>
                        </div>
                        <div class="cart-controls">
                            <button onclick="updateCart(${product.id}, -1)">‚àí</button>
                            <span style="font-weight:600; font-size:16px;">${cart[id]}</span>
                            <button onclick="updateCart(${product.id}, 1)">+</button>
                        </div>
                    `;
                    list.appendChild(el);
                }
            });
        }

        // --- üß≠ –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function togglePage(page) {
            currentPage = page;
            const catalog = document.getElementById('catalogPage');
            const cartP = document.getElementById('cartPage');

            if (page === 'cart') {
                catalog.classList.remove('active');
                cartP.classList.add('active');
                renderCartPage();
                tg.BackButton.show();
            } else {
                cartP.classList.remove('active');
                catalog.classList.add('active');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω–µ
                applyFilters(); 
                tg.BackButton.hide();
            }
            updateMainButton();
        }

        tg.BackButton.onClick(() => togglePage('catalog'));

        // --- üîµ –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê ---
        function updateMainButton() {
            let totalSum = 0;
            let totalCount = 0;

            for (let id in cart) {
                const product = products.find(p => p.id == id);
                if(product) {
                    totalSum += product.price * cart[id];
                    totalCount += cart[id];
                }
            }

            if (totalCount > 0) {
                const text = currentPage === 'catalog' 
                    ? `–ö–æ—Ä–∑–∏–Ω–∞ (${totalSum.toFixed(2)} BYN)` 
                    : `–û—Ñ–æ—Ä–º–∏—Ç—å: ${totalSum.toFixed(2)} BYN`;
                
                tg.MainButton.setText(text);
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            if (currentPage === 'catalog') {
                togglePage('cart');
            } else {
                // –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ë–û–¢–£
                const data = {
                    items: [],
                    totalPrice: 0
                };
                for (let id in cart) {
                    const product = products.find(p => p.id == id);
                    if (product) {
                        data.items.push({
                            name: product.name,
                            price: product.price,
                            quantity: cart[id],
                            sum: (product.price * cart[id]).toFixed(2)
                        });
                        data.totalPrice += product.price * cart[id];
                    }
                }
                tg.sendData(JSON.stringify(data)); 
            }
        });

        // --- üîç –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ ---
        function filterCategory(cat, el) {
            currentCategory = cat;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            applyFilters();
        }

        searchInput.addEventListener('input', applyFilters);

        function applyFilters() {
            const query = searchInput.value.toLowerCase();
            const filtered = products.filter(p => {
                const catMatch = currentCategory === 'all' || p.category === currentCategory;
                const nameMatch = p.name.toLowerCase().includes(query);
                return catMatch && nameMatch;
            });
            renderCatalog(filtered);
        }

        // --- POPUP ---
        function openPopup(id) {
            const p = products.find(x => x.id === id);
            if(!p) return;
            document.getElementById('popupImg').src = p.img;
            document.getElementById('popupTitle').innerText = p.name;
            document.getElementById('popupPrice').innerText = p.price.toFixed(2) + " BYN";
            document.getElementById('popupDesc').innerText = p.desc;
            document.getElementById('popup').classList.add('show');
        }
        function closePopup(e) { if(e.target.id === 'popup') closePopupDirect(); }
        function closePopupDirect() { document.getElementById('popup').classList.remove('show'); }

        // START
        renderCatalog(products);

    </script>
</body>
</html>
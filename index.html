<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shop v0.5 BYN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–ò–õ–ï–ô --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
            margin: 0; 
            padding: 0; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü */
        .page {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            padding-bottom: 90px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ MainButton */
            animation: fadeEffect 0.2s;
        }
        
        .page.active {
            display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é */
        }

        @keyframes fadeEffect {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- –®–ê–ü–ö–ê (–ü–û–ò–°–ö + –¢–ê–ë–´) --- */
        .header {
            position: sticky;
            top: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            z-index: 100;
            padding: 10px 10px 5px 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .search-input {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 15px;
            border-radius: 12px;
            border: none;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
            font-size: 16px;
            outline: none;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 5px;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }

        .tab {
            white-space: nowrap;
            padding: 8px 14px;
            border-radius: 18px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-hint-color, #888);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .tab.active {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
        }

        /* --- –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .card {
            background-color: var(--tg-theme-bg-color, #fff);
            border: 1px solid var(--tg-theme-secondary-bg-color, #e0e0e0);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .card img {
            width: 100%;
            height: 110px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .name { font-size: 14px; font-weight: 600; margin-bottom: 4px; height: 34px; overflow: hidden; line-height: 1.2; }
        .price { font-size: 15px; font-weight: 700; margin-bottom: 10px; }
        .currency { font-size: 12px; font-weight: 400; color: #888; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-add, .counter {
            width: 100%;
            height: 34px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        .btn-add {
            background-color: var(--tg-theme-secondary-bg-color, #eef);
            color: var(--tg-theme-button-color, #2481cc);
        }
        .counter {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: white;
            justify-content: space-between;
            padding: 0 2px;
            box-sizing: border-box;
            display: none;
        }
        .counter button {
            background: none; border: none; color: white; font-size: 18px; width: 30px; cursor: pointer; height: 100%;
        }

        /* --- –°–¢–†–ê–ù–ò–¶–ê –ö–û–†–ó–ò–ù–´ --- */
        .cart-container { padding: 15px; }
        .cart-header { font-size: 22px; font-weight: 800; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        .cart-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 15px; }
        .cart-info { flex-grow: 1; }
        .cart-title { font-weight: 600; font-size: 15px; }
        .cart-price { color: #888; font-size: 13px; }
        
        .cart-controls {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-secondary-bg-color, #eee);
            border-radius: 6px;
            padding: 2px;
        }
        .cart-controls button {
            border: none; background: none; color: var(--tg-theme-text-color); font-size: 16px; width: 25px; cursor: pointer;
        }
        .cart-controls span { font-weight: 600; font-size: 14px; margin: 0 5px; min-width: 15px; text-align: center;}

        /* --- POPUP (–ú–û–î–ê–õ–ö–ê) --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .popup-overlay.show { display: flex; }
        .popup-content {
            background: var(--tg-theme-bg-color, #fff);
            width: 80%;
            max-width: 320px;
            border-radius: 16px;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .popup-close { position: absolute; top: 10px; right: 10px; background: #f0f0f0; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
        .popup-img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }

    </style>
</head>
<body>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ö–ê–¢–ê–õ–û–ì -->
    <div id="catalogPage" class="page active">
        <div class="header">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
            <div class="tabs">
                <div class="tab active" onclick="filterCategory('all', this)">–í—Å–µ</div>
                <div class="tab" onclick="filterCategory('clothes', this)">–û–¥–µ–∂–¥–∞</div>
                <div class="tab" onclick="filterCategory('souvenirs', this)">–°—É–≤–µ–Ω–∏—Ä—ã</div>
                <div class="tab" onclick="filterCategory('food', this)">–ï–¥–∞</div>
            </div>
        </div>
        <div id="grid" class="product-grid"></div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –ö–û–†–ó–ò–ù–ê -->
    <div id="cartPage" class="page">
        <div class="cart-container">
            <div class="cart-header">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ üõí</div>
            <div id="cartList"></div>
            <div id="emptyCart" style="text-align: center; color: #888; margin-top: 40px; display: none;">
                –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî<br>–î–æ–±–∞–≤—å—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤–∫—É—Å–Ω–æ–µ!
            </div>
        </div>
    </div>

    <!-- POPUP -->
    <div id="popup" class="popup-overlay" onclick="closePopup(event)">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopupDirect()">√ó</button>
            <img id="popupImg" class="popup-img" src="">
            <h3 id="popupTitle" style="margin: 0 0 5px;"></h3>
            <div id="popupPrice" style="font-weight: bold; margin-bottom: 10px;"></div>
            <p id="popupDesc" style="font-size: 14px; color: #666;"></p>
            <button class="btn-add" style="background: var(--tg-theme-button-color); color: #fff;" onclick="closePopupDirect()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        // --- –î–ê–ù–ù–´–ï (–ó–ê–ú–ï–ù–ò–¢–ï –°–°–´–õ–ö–ò –ù–ê –°–í–û–ò) ---
        const products = [
            { id: 1, category: "clothes", name: "–§—É—Ç–±–æ–ª–∫–∞ –ú–∏–Ω—Å–∫", price: 45.00, img: "https://placehold.co/400x400/png?text=Minsk", desc: "–•–ª–æ–ø–æ–∫ 100%, –ø—Ä–∏–Ω—Ç —à–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏—è." },
            { id: 2, category: "clothes", name: "–•—É–¥–∏ –ë–µ–ª–∞—Ä—É—Å—å", price: 85.00, img: "https://placehold.co/400x400/png?text=Hoodie", desc: "–¢–µ–ø–ª—ã–π —Ö—É–¥–∏ —Å –Ω–∞—á–µ—Å–æ–º." },
            { id: 3, category: "souvenirs", name: "–ö—Ä—É–∂–∫–∞ –í–∞—Å–∏–ª—ë–∫", price: 20.00, img: "https://placehold.co/400x400/png?text=Mug", desc: "–ö–µ—Ä–∞–º–∏–∫–∞, 300 –º–ª." },
            { id: 4, category: "souvenirs", name: "–®–æ–ø–ø–µ—Ä –õ—ë–Ω", price: 15.00, img: "https://placehold.co/400x400/png?text=Shopper", desc: "–≠–∫–æ-—Å—É–º–∫–∞." },
            { id: 5, category: "food", name: "–ß–∏–ø—Å—ã –ë—É–ª—å–±–∞", price: 3.50, img: "https://placehold.co/400x400/png?text=Chips", desc: "–í–∫—É—Å —Å–º–µ—Ç–∞–Ω—ã –∏ –ª—É–∫–∞." },
            { id: 6, category: "clothes", name: "–ö–µ–ø–∫–∞ –ú–µ–Ω—Å–∫", price: 30.00, img: "https://placehold.co/400x400/png?text=Cap", desc: "–ß–µ—Ä–Ω–∞—è, —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä." },
            { id: 7, category: "food", name: "–°–≥—É—â–µ–Ω–∫–∞", price: 4.50, img: "https://placehold.co/400x400/png?text=Milk", desc: "–ì–ª—É–±–æ–∫—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è." }
        ];

        let cart = {}; // { id: quantity }
        let currentCategory = 'all';
        let currentPage = 'catalog'; // catalog | cart

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        const grid = document.getElementById('grid');
        const searchInput = document.getElementById('searchInput');

        // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞
        function renderCatalog(items) {
            grid.innerHTML = "";
            if (items.length === 0) {
                grid.innerHTML = "<div style='grid-column: span 2; text-align: center; padding: 20px; color: #888;'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>";
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <img src="${item.img}" onclick="openPopup(${item.id})">
                    <div class="name">${item.name}</div>
                    <div class="price">${item.price.toFixed(2)} <span class="currency">BYN</span></div>
                    
                    <button class="btn-add" id="add-${item.id}" onclick="updateCart(${item.id}, 1)">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    
                    <div class="counter" id="counter-${item.id}">
                        <button onclick="updateCart(${item.id}, -1)">‚àí</button>
                        <span id="count-${item.id}">0</span>
                        <button onclick="updateCart(${item.id}, 1)">+</button>
                    </div>
                `;
                grid.appendChild(div);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                if (cart[item.id]) {
                    showCounter(item.id, cart[item.id]);
                }
            });
        }

        // --- –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø) ---
        function updateCart(id, change) {
            tg.HapticFeedback.impactOccurred('light');

            const productId = parseInt(id);
            const delta = parseInt(change);

            if (!cart[productId]) cart[productId] = 0;
            cart[productId] += delta;

            if (cart[productId] <= 0) {
                delete cart[productId];
                // –ï—Å–ª–∏ –º—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                hideCounter(productId); 
            } else {
                // –ï—Å–ª–∏ –º—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                showCounter(productId, cart[productId]);
            }

            // –ï—Å–ª–∏ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
            if (currentPage === 'cart') {
                renderCartPage();
            }

            updateMainButton();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI
        function showCounter(id, count) {
            const addBtn = document.getElementById(`add-${id}`);
            const counter = document.getElementById(`counter-${id}`);
            const countSpan = document.getElementById(`count-${id}`);
            if(addBtn && counter && countSpan) {
                addBtn.style.display = 'none';
                counter.style.display = 'flex';
                countSpan.innerText = count;
            }
        }

        function hideCounter(id) {
            const addBtn = document.getElementById(`add-${id}`);
            const counter = document.getElementById(`counter-${id}`);
            if(addBtn && counter) {
                addBtn.style.display = 'flex';
                counter.style.display = 'none';
            }
        }

        // --- –°–¢–†–ê–ù–ò–¶–ê –ö–û–†–ó–ò–ù–´ ---
        function renderCartPage() {
            const list = document.getElementById('cartList');
            const emptyMsg = document.getElementById('emptyCart');
            list.innerHTML = "";
            
            const itemIds = Object.keys(cart);

            if (itemIds.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            itemIds.forEach(id => {
                const product = products.find(p => p.id == id);
                if (product) {
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = `
                        <img src="${product.img}">
                        <div class="cart-info">
                            <div class="cart-title">${product.name}</div>
                            <div class="cart-price">${product.price.toFixed(2)} BYN</div>
                        </div>
                        <div class="cart-controls">
                            <button onclick="updateCart(${product.id}, -1)">‚àí</button>
                            <span>${cart[id]}</span>
                            <button onclick="updateCart(${product.id}, 1)">+</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function togglePage(pageName) {
            currentPage = pageName;
            const catalog = document.getElementById('catalogPage');
            const cartPage = document.getElementById('cartPage');

            if (pageName === 'cart') {
                renderCartPage();
                catalog.classList.remove('active');
                cartPage.classList.add('active');
                tg.BackButton.show(); // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–µ–ª–∫—É –Ω–∞–∑–∞–¥
            } else {
                cartPage.classList.remove('active');
                catalog.classList.add('active');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω–µ
                applyFilters(); 
                tg.BackButton.hide(); // –°–∫—Ä—ã—Ç—å —Å—Ç—Ä–µ–ª–∫—É –Ω–∞–∑–∞–¥
            }
            updateMainButton();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.onEvent('backButtonClicked', function() {
            togglePage('catalog');
        });

        // --- –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê (SMART BUTTON) ---
        function updateMainButton() {
            let totalSum = 0;
            let totalCount = 0;

            for (let id in cart) {
                const product = products.find(p => p.id == id);
                if(product) {
                    totalSum += product.price * cart[id];
                    totalCount += cart[id];
                }
            }

            if (totalCount > 0) {
                if (currentPage === 'catalog') {
                    tg.MainButton.setText(`–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É (${totalSum.toFixed(2)} BYN)`);
                    tg.MainButton.show();
                } else {
                    tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${totalSum.toFixed(2)} BYN`);
                    tg.MainButton.show();
                }
            } else {
                tg.MainButton.hide();
            }
        }

        // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –ì–õ–ê–í–ù–£–Æ –ö–ù–û–ü–ö–£
        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            if (currentPage === 'catalog') {
                // –ï—Å–ª–∏ –º—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ -> –∏–¥–µ–º –≤ –∫–æ—Ä–∑–∏–Ω—É
                togglePage('cart');
            } else {
                // –ï—Å–ª–∏ –º—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -> –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –±–æ—Ç—É
                const data = { items: [], totalPrice: 0 };
                for (let id in cart) {
                    const product = products.find(p => p.id == id);
                    if (product) {
                        data.items.push({ 
                            name: product.name, 
                            price: product.price, 
                            quantity: cart[id],
                            sum: (product.price * cart[id]).toFixed(2)
                        });
                        data.totalPrice += product.price * cart[id];
                    }
                }
                tg.sendData(JSON.stringify(data)); 
            }
        });

        // --- –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ ---
        function filterCategory(cat, element) {
            currentCategory = cat;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(element) element.classList.add('active');
            applyFilters();
        }
        
        searchInput.addEventListener('input', applyFilters);

        function applyFilters() {
            const query = searchInput.value.toLowerCase();
            const filtered = products.filter(p => {
                const matchesCategory = currentCategory === 'all' || p.category === currentCategory;
                const matchesSearch = p.name.toLowerCase().includes(query);
                return matchesCategory && matchesSearch;
            });
            renderCatalog(filtered);
        }

        // --- POPUP ---
        function openPopup(id) {
            const item = products.find(p => p.id === id);
            if(!item) return;
            document.getElementById('popupImg').src = item.img;
            document.getElementById('popupTitle').innerText = item.name;
            document.getElementById('popupPrice').innerText = item.price.toFixed(2) + " BYN";
            document.getElementById('popupDesc').innerText = item.desc;
            document.getElementById('popup').classList.add('show');
        }
        function closePopup(e) { if(e.target === document.getElementById('popup')) closePopupDirect(); }
        function closePopupDirect() { document.getElementById('popup').classList.remove('show'); }

        // –ó–ê–ü–£–°–ö
        renderCatalog(products);

    </script>
</body>
</html>